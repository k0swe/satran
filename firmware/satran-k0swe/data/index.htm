<!DOCTYPE html>
<html>
  <head>
    <title>SATRAN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.svg" />
    <style>
      body {
        font-family: verdana, helvetica, sans-serif;
        padding: 25px;
      }
      input,
      select {
        width: 100%;
        max-width: 350px;
        padding: 6px 12px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      .btn {
        cursor: pointer;
        padding: 10px;
        background: #eee;
        border: 1px solid #777;
        border-radius: 4px;
        margin: 10px;
        min-width: 200px;
      }
      #submit {
        margin: 20px auto;
      }
    </style>
    <script>
      function parseMessage(msg) {
        const obj = JSON.parse(msg);
        if (obj.hasOwnProperty("azDeg") && obj.hasOwnProperty("elDeg")) {
          const azimuthDeg = obj["azDeg"];
          const elevationDeg = obj["elDeg"];
          document.getElementById("currentAzimuth").value = azimuthDeg;
          document.getElementById("currentElevation").value = elevationDeg;
        }
        if (obj.hasOwnProperty("azSensor") && obj.hasOwnProperty("elSensor")) {
          const azimuthSensor = obj["azSensor"];
          const elevationSensor = obj["elSensor"];
          document.getElementById("azSensor").innerText = azimuthSensor;
          document.getElementById("elSensor").innerText = elevationSensor;
        }
        if (
          obj.hasOwnProperty("targetAzDeg") &&
          obj.hasOwnProperty("targetElDeg")
        ) {
          const targetAzimuth = obj["targetAzDeg"];
          const targetElevation = obj["targetElDeg"];
          document.getElementById("targetAzimuth").placeholder = targetAzimuth;
          document.getElementById("targetElevation").placeholder =
            targetElevation;
        }
      }

      function setTarget() {
        const targetAzimuth = document.getElementById("targetAzimuth").value;
        const targetElevation =
          document.getElementById("targetElevation").value;
        let obj = {};
        if (targetAzimuth !== "") {
          obj["targetAzDeg"] = targetAzimuth;
        }
        if (targetElevation !== "") {
          obj["targetElDeg"] = targetElevation;
        }
        ws.send(JSON.stringify(obj));
      }

      keyDownHandler = (event) => {
        if (event.code === "Enter") {
          setTarget();
        }
      };

      // Configure and start WebSocket client
      function startSocket() {
        ws = new WebSocket("ws://" + document.location.host + "/ws", [
          "arduino",
        ]);
        ws.binaryType = "arraybuffer";
        ws.onmessage = function (e) {
          parseMessage(e.data);
        };
        ws.addEventListener("close", function (event) {
          console.log("WS connection closed");
          setTimeout(startSocket, 5000);
        });
        ws.addEventListener("error", function (event) {
          console.log("WS connection error", event);
          setTimeout(startSocket, 5000);
        });
      }

      // When page is fully loaded start connection
      function onBodyLoad() {
        startSocket();
        document
          .getElementById("targetAzimuth")
          .addEventListener("keydown", keyDownHandler, true);
        document
          .getElementById("targetElevation")
          .addEventListener("keydown", keyDownHandler, true);
      }
    </script>
  </head>
  <body style="text-align: center" onload="onBodyLoad()">
    <h1>SATRAN Rotator</h1>
    <div style="display: flex; flex-direction: row; justify-content: center">
      <div>
        Current Azimuth <br />
        <input
          type="number"
          id="currentAzimuth"
          name="currentAzimuth"
          disabled
        />
        <br />
        Current Elevation <br />
        <input
          type="number"
          id="currentElevation"
          name="currentElevation"
          disabled
        />
        <br />
      </div>
      <div>
        Target Azimuth <br />
        <input type="number" id="targetAzimuth" />
        <br />
        Target Elevation <br />
        <input type="number" id="targetElevation" />
        <input type="submit" value="Execute" onsubmit="setTarget()" />
      </div>
    </div>
    <p style="font-size: 0.8em; color: #888">
      SATRAN firmware 3.0-rc<br />
      &copy; 2024-01-08 K0SWE<br />
      &copy; 2022-10-19 Danaco<br />
      Sensor values: Azimuth <span id="azSensor"></span>, Elevation
      <span id="elSensor"></span>
    </p>
  </body>
</html>
